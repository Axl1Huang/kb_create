#!/usr/bin/env python3
"""
çŸ¥è¯†å›¾è°±æ„å»ºå·¥å…· - ç»Ÿä¸€å…¥å£

ä½¿ç”¨æ–¹æ³•:
    python main.py                          # è¿è¡Œå®Œæ•´ç®¡é“
    python main.py --skip-pdf                # è·³è¿‡PDFå¤„ç†ï¼Œåªå¯¼å…¥æ•°æ®
    python main.py --skip-import             # åªå¤„ç†PDFï¼Œä¸å¯¼å…¥æ•°æ®
    python main.py --help                    # æŸ¥çœ‹å¸®åŠ©
"""

import sys
import os
from pathlib import Path

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent / 'src'))

from core import Config, KnowledgePipeline, setup_logging

def main():
    import argparse
    
    parser = argparse.ArgumentParser(
        description="å­¦æœ¯è®ºæ–‡çŸ¥è¯†å›¾è°±æ„å»ºå·¥å…·",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  python main.py                          # å®Œæ•´å¤„ç†æµç¨‹
  python main.py --skip-pdf               # åªå¤„ç†å·²æœ‰çš„Markdownæ–‡ä»¶
  python main.py --skip-import            # åªè½¬æ¢PDFä¸ºMarkdown
  python main.py --log-level DEBUG        # è°ƒè¯•æ¨¡å¼è¿è¡Œ
        """
    )
    
    parser.add_argument(
        "--skip-pdf",
        action="store_true",
        help="è·³è¿‡PDFå¤„ç†é˜¶æ®µï¼ˆå‡è®¾å·²æœ‰Markdownæ–‡ä»¶ï¼‰"
    )
    
    parser.add_argument(
        "--skip-import", 
        action="store_true",
        help="è·³è¿‡æ•°æ®å¯¼å…¥é˜¶æ®µï¼ˆåªç”ŸæˆMarkdownæ–‡ä»¶ï¼‰"
    )
    
    parser.add_argument(
        "--log-level",
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        default="INFO",
        help="è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤: INFOï¼‰"
    )

    parser.add_argument(
        "--limit-pdfs",
        type=int,
        default=None,
        help="ä»…å¤„ç†å‰Nä¸ªPDFï¼ˆç”¨äºå¤§æ‰¹é‡æµ‹è¯•/åˆ†æ‰¹ç›‘æ§ï¼‰"
    )

    parser.add_argument(
        "--limit-md",
        type=int,
        default=None,
        help="ä»…å¯¼å…¥å‰Nä¸ªMarkdownï¼ˆç”¨äºå¤§æ‰¹é‡æµ‹è¯•/åˆ†æ‰¹ç›‘æ§ï¼‰"
    )
    
    parser.add_argument(
        "--stats-every",
        type=int,
        default=None,
        help="æ¯ N ä¸ªæ–‡ä»¶è¾“å‡ºé˜¶æ®µç»Ÿè®¡å¹¶å†™å…¥ logs/pdf_progress.jsonl"
    )
    
    parser.add_argument(
        "--config",
        type=Path,
        help="æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤: config/config.envï¼‰"
    )
    
    args = parser.parse_args()
    
    try:
        # åŠ è½½é…ç½®
        config = Config(config_path=args.config)
        config.setup_directories()
        
        # è®¾ç½®æ—¥å¿—
        log_file = config.paths.logs_dir / "knowledge_graph.log"
        logger = setup_logging(log_file, args.log_level)
        
        logger.info("=" * 50)
        logger.info("å­¦æœ¯è®ºæ–‡çŸ¥è¯†å›¾è°±æ„å»ºå·¥å…·")
        logger.info("=" * 50)
        
        # åˆ›å»ºç®¡é“
        pipeline = KnowledgePipeline(config)
        
        # è¿è¡Œç®¡é“
        results = pipeline.run_full_pipeline(
            skip_pdf=args.skip_pdf,
            skip_import=args.skip_import,
            limit_pdfs=args.limit_pdfs,
            limit_md=args.limit_md,
            stats_every=args.stats_every
        )
        
        # è¾“å‡ºç»“æœ
        print("\n" + "=" * 50)
        print("æ‰§è¡Œç»“æœ:")
        print("=" * 50)
        
        if results['success']:
            print("âœ… ç®¡é“æ‰§è¡ŒæˆåŠŸ")
        else:
            print("âŒ ç®¡é“æ‰§è¡Œå¤±è´¥")
            
        if results.get('pdf_processing'):
            pdf = results['pdf_processing']
            print(f"ğŸ“„ PDFå¤„ç†: {pdf['processed']} æˆåŠŸ, {pdf['failed']} å¤±è´¥")
            
        if results.get('data_import'):
            imp = results['data_import']
            print(f"ğŸ’¾ æ•°æ®å¯¼å…¥: {imp['imported']} æˆåŠŸ, {imp['failed']} å¤±è´¥")
            
        if results.get('error'):
            print(f"â— é”™è¯¯: {results['error']}")
            
        print("=" * 50)
        
        return 0 if results['success'] else 1
        
    except KeyboardInterrupt:
        print("\nâš ï¸  ç”¨æˆ·ä¸­æ–­æ‰§è¡Œ")
        return 130
    except Exception as e:
        print(f"\nâŒ è‡´å‘½é”™è¯¯: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())